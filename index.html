<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Top 10 Malaysian Banks Performance with base 1 Jul 2024</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <style>
    :root { font-family: 'Segoe UI', Tahoma, sans-serif; background:#f4f4f4; }
    body { margin:0; padding:1rem; }
    h1 { text-align:center; font-size:1.75rem; }
    .container { max-width:1200px; margin:0 auto; background:#fff; padding:1rem 2rem; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .meta { text-align:center; color:#666; margin-bottom:1rem; }
    canvas { width:100%; max-height:600px; }
    .slider-controls {
      margin-top:1.5rem;
      display:flex;
      flex-direction:column;
      gap:0.35rem;
    }
    .slider-controls label { font-weight:600; color:#333; }
    .slider-controls input[type="range"] { width:100%; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Top 10 Malaysian Banks Performance with base 1 Jul 2024 – <span id="titleTimestamp">Loading…</span></h1>
    <p class="meta">Last updated (SGT): <span id="updatedAt">Loading latest data…</span></p>
    <canvas id="banksChart"></canvas>
    <div class="slider-controls" id="sliderControls" hidden>
      <label for="windowSlider">Visible window: <span id="sliderLabel">Full range</span></label>
      <input type="range" id="windowSlider" min="0" value="0" step="1" />
    </div>
  </div>
  <script>
    async function initChart() {
      const meta = document.getElementById('updatedAt');
      const titleTimestamp = document.getElementById('titleTimestamp');
      const sliderControls = document.getElementById('sliderControls');
      const slider = document.getElementById('windowSlider');
      const sliderLabel = document.getElementById('sliderLabel');
      try {
        const response = await fetch('chart-data.json', { cache: 'no-cache' });
        if (!response.ok) {
          throw new Error(`Failed to fetch chart data: ${response.status}`);
        }
        const chartData = await response.json();
        const updatedLabel = chartData.updatedAtLabel || chartData.updatedAt || 'Unknown';
        meta.textContent = updatedLabel;
        titleTimestamp.textContent = updatedLabel;
        const ctx = document.getElementById('banksChart').getContext('2d');
        const chart = new Chart(ctx, {
          type: 'line',
          data: { datasets: chartData.datasets },
          options: {
            responsive: true,
            interaction: { mode: 'nearest', axis: 'x', intersect: false },
            stacked: false,
            scales: {
              x: { type: 'time', time: { unit: 'month' }, title: { display: true, text: 'Date' } },
              y: {
                title: { display: true, text: chartData.yTitle || 'Relative Price' },
                ticks: { callback: (value) => (typeof value === 'number' ? value.toFixed(2) : value) }
              }
            },
            plugins: { legend: { position: 'bottom' } }
          }
        });

        configureSlider(chart, chartData, sliderControls, slider, sliderLabel);
      } catch (error) {
        meta.textContent = 'Failed to load data';
        titleTimestamp.textContent = 'Unavailable';
        console.error(error);
      }
    }

    function configureSlider(chart, chartData, controls, slider, label) {
      const DEFAULT_WINDOW_POINTS = 130;
      const dates = Array.from(
        new Set(
          chartData.datasets.flatMap((dataset) =>
            (dataset.data || []).map((point) => point.x)
          )
        )
      ).sort();
      if (dates.length === 0) {
        controls.hidden = true;
        return;
      }
      const windowSize = Math.min(DEFAULT_WINDOW_POINTS, dates.length);
      const maxStartIndex = Math.max(dates.length - windowSize, 0);
      slider.max = String(maxStartIndex);
      slider.value = String(maxStartIndex);

      if (dates.length <= windowSize) {
        controls.hidden = true;
        chart.options.scales.x.min = undefined;
        chart.options.scales.x.max = undefined;
        chart.update('none');
        return;
      }

      controls.hidden = false;

      const formatRangeLabel = (startISO, endISO) => {
        const start = luxon.DateTime.fromISO(startISO).toFormat('dd LLL yyyy');
        const end = luxon.DateTime.fromISO(endISO).toFormat('dd LLL yyyy');
        return `${start} → ${end}`;
      };

      const applyWindow = (startIndex) => {
        const startISO = dates[startIndex];
        const endISO = dates[Math.min(startIndex + windowSize - 1, dates.length - 1)];
        chart.options.scales.x.min = startISO;
        chart.options.scales.x.max = endISO;
        chart.update('none');
        label.textContent = formatRangeLabel(startISO, endISO);
      };

      slider.addEventListener('input', (event) => {
        const startIndex = Number(event.target.value);
        applyWindow(startIndex);
      });

      applyWindow(maxStartIndex);
    }
    initChart();
  </script>
</body>
</html>